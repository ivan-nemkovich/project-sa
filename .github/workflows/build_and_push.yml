name: Build and Publish image

on:
  push:
    branches:
      - "image"
    tags:
      - v**
jobs:
  push_to_registries:
    name: Push Docker image
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - name: Get tag
        id: tag
        uses: dawidd6/action-get-tag@v1
        with:
        # Optionally strip `v` prefix
          strip_v: true

      - name: Check out the repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.CR_TOKEN }}

     # - name: Log in to the Container registry
     #   uses: docker/login-action@v2
     #   with:
     #     registry: ghcr.io
     #     username: ${{ github.actor }}
     #     password: ${{ secrets.CR_TOKEN }}

     # - name: Build and push Docker images
     #   uses: docker/build-push-action@v3
     #   with:
     #     context: ./image
     #     push: true
     #     tags: ghcr.io/ivan-nemkovich/wp_project:latest,ghcr.io/ivan-nemkovich/wp_project:${{ steps.tag.outputs.tag }} 

      - name: Helm tool installer
        uses: Azure/setup-helm@v3
      
      - name: Helm Package
        run: |
          helm package chart/wp_project --version=${{ steps.tag.outputs.tag }} --app-version=${{ steps.tag.outputs.tag }}
          helm repo index --url https://ivan-nemkovich.github.io/project-sa/ --merge index.yaml .

      - name: Commit and push changes
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "generated"
          git push origin main
